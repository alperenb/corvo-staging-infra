---
## This playbook deploys the whole application stack in this site.

# Apply common configuration to all hosts except proxmox.
- hosts: all:!proxmox
  gather_facts: false
  roles:
    - common
  tags:
    - common

# Configure Redis Cluster.
- hosts: redis_master
  roles:
    - role: redis
      sentinel:
        enabled: yes
        master: 
          ip: "{{ hostvars[inventory_hostname]['master'] }}"
          port: "{{ hostvars[groups['redis'][0]]['port'] }}"
        quorum: 2
  tags:
    - redis

- hosts: redis_slave
  roles:
    - role: redis
      sentinel:
        enabled: yes
        master:
          ip: "{{ hostvars[inventory_hostname]['master'] }}"
          port: "{{ hostvars[groups['redis_master'][0]]['port'] }}"
        quorum: 2
  tags:
    - redis

# RabbitMQ Cluster
- hosts: rabbitmq
  roles:
    - rabbitmq
  tags:
    - rabbitmq

# Create an NFS host
- hosts: nfs_server
  roles:
    - nfs
  tags:
    - nfs_server


# Configure NGinx load balancers with active/passive configuration via keepalived.
- hosts: nginx
  roles:
    - role: nginx
      upstreams:
        - name: REST_API
          servers:
            - "{{ hostvars[groups['restapi'][0]]['ansible_host'] }}:{{ hostvars[groups['restapi'][0]]['port'] }}"
            - "{{ hostvars[groups['restapi'][1]]['ansible_host'] }}:{{ hostvars[groups['restapi'][1]]['port'] }}"
        - name: LYREBIRD_WS
          servers:
            - "{{ hostvars[groups['lyrebird'][0]]['ansible_host'] }}:{{ hostvars[groups['lyrebird'][0]]['port'] }}"
            - "{{ hostvars[groups['lyrebird'][1]]['ansible_host'] }}:{{ hostvars[groups['lyrebird'][1]]['port'] }}"
    - role: keepalived
      virtual_ip: "{{ hostvars[groups['nginx'][0]]['virtual_ip'] }}"
      network_interface_name: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['interface'] }}"
      pid: nginx
  tasks:
    - include_tasks: deploy-to-nginx.yml
  tags:
    - nginx
    - jsclient


  